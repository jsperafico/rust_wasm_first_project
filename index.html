<!DOCTYPE html>
<html>
    <header>
        <title>How about game of life?</title>
        <style>
            body {
                padding: 5%;
                width: 89%;
                height: 89%;
                display: grid;
                grid-template-areas: 
                        "fps1 fps2" 
                        "game1 game2";
            }
            h1 {
                grid-area: fps1;
            }
            div#game1 {
                grid-area: game1;
            }
            h2 {
                grid-area: fps2;
            }
            pre#game2 {
                grid-area: game2;
                white-space: pre-wrap;
                letter-spacing: .2rem;
            }
        </style>
        <script type='module'>
            import init, {Cell, Universe} from './package/game_of_life.js';

            async function runGameOfLife() {
                await init();
                const div = document.getElementById('game1');
                const h1 = document.getElementsByTagName('h1')[0];
                const universe = Universe.new();
                const times = [];

                function renderGameOfLife(timestamp) {
                    const now = performance.now();
                    while (times.length > 0 && times[0] <= now - 1000) {
                        times.shift();
                    }
                    times.push(now);

                    h1.innerHTML = 'FPS: ' + times.length;
                    div.textContent = universe.render(), 'text/html';
                    universe.tick();

                    window.requestAnimationFrame(renderGameOfLife);
                }
                renderGameOfLife();
            }
            runGameOfLife();
        </script>
        <script type='module'>
            import init, {Engine, Result, Action} from './package/space_invaders.js';
            String.prototype.replace('&nbsp',' ');

            async function runSpaceInvaders() {
                await init();
                const h2 = document.getElementsByTagName('h2')[0];
                const pre = document.getElementById('game2');
                const engine = Engine.new();
                const times = [];

                const keyup = (event) => {
                    if (engine.is_endgame() != Result.NONE) {
                        window.removeEventListener('keyup', keyup);
                    }

                    if (event.code === 'ArrowLeft') {
                        engine.input(Action.LEFT);
                    }
                    if (event.code === 'ArrowRight') {
                        engine.input(Action.RIGHT);
                    }
                    if (event.code === 'Space') {
                        engine.input(Action.SHOOT);
                    }
                };

                window.addEventListener('keyup', keyup);

                function renderSpaceInvaders(timestamp) {
                    if (engine.is_endgame() != Result.NONE) {
                        return;
                    }

                    const now = performance.now();
                    while (times.length > 0 && times[0] <= now - 1000) {
                        times.shift();
                    }
                    times.push(now);

                    h2.innerHTML = 'FPS: ' + times.length;
                    pre.innerText = engine.render();
                    engine.tick();

                    window.requestAnimationFrame(renderSpaceInvaders);
                }
                renderSpaceInvaders();
            }
            runSpaceInvaders();
        </script>
    </header>
    <body>
        <h1>FPS:</h1>
        <div id="game1"></div>
        <h2>FPS:</h2>
        <pre id="game2"></pre>
    </body>
</html>